on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: read
  pull-requests: read

jobs:
  commit-title-check:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -eu
          gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json commits \
            --jq '.commits[].messageHeadline' > titles.txt
          set +e
          grep -E '^[a-z]+:' titles.txt
          code=$?
          case "$code" in
          0)
            echo "::error::Commit titles must not start with prefixes like 'feat:', use normal sentences, write for humans" >&2
            exit 1
            ;;
          1)
            exit 0
            ;;
          *)
            echo "::error::grep failed with exit code $code"
            exit $code
            ;;
          esac
